# 图书馆预约系统API清单

## 一、微信小程序原生API

| 类别         | API名称                              | 功能描述                                                                 | 使用场景                                  |
|--------------|--------------------------------------|--------------------------------------------------------------------------|-------------------------------------------|
| 网络通信     | `wx.connectSocket()`                 | 建立WebSocket长连接，用于实时数据传输                                   | 首页初始化时建立与服务器的实时连接        |
| 网络通信     | `wx.onSocketOpen()`                  | 监听WebSocket连接打开事件                                               | 连接成功后发送初始化消息（如用户身份）    |
| 网络通信     | `wx.onSocketMessage()`               | 监听服务器通过WebSocket推送的消息                                       | 接收座位状态更新、预约提醒等实时数据      |
| 网络通信     | `wx.sendSocketMessage()`             | 通过WebSocket向服务器发送消息                                           | 发送预约请求、订阅特定图书馆的座位更新    |
| 网络通信     | `wx.closeSocket()`                   | 关闭WebSocket连接                                                       | 页面卸载或用户退出时断开连接              |
| 用户信息     | `wx.getUserProfile()`                | 获取用户信息（需用户授权），包含头像、昵称等                             | 登录功能，完善用户资料                    |
| 本地存储     | `wx.setStorageSync()`                | 同步存储数据到本地（持久化）                                             | 保存用户信息、预约记录、偏好设置          |
| 本地存储     | `wx.getStorageSync()`                | 从本地同步读取数据                                                       | 页面加载时恢复用户状态、显示历史预约      |
| 页面导航     | `wx.navigateTo()`                    | 跳转到新页面（保留当前页面在栈中）                                       | 从首页跳转到图书馆详情页                  |
| 页面导航     | `wx.navigateBack()`                  | 返回上一页面                                                             | 从详情页返回首页                          |
| 交互反馈     | `wx.showToast()`                     | 显示轻量级消息提示框（如成功、失败提示）                                 | 预约成功、数据刷新、操作错误等场景        |
| 交互反馈     | `wx.showLoading()`                   | 显示加载提示框（需手动关闭）                                             | 数据加载、预约请求等耗时操作              |
| 交互反馈     | `wx.hideLoading()`                   | 隐藏加载提示框                                                           | 耗时操作完成后关闭加载状态                |
| DOM操作      | `wx.createSelectorQuery()`           | 获取页面元素的布局信息（宽高、位置等）                                   | D3.js图表渲染前获取容器尺寸                |

## 二、业务逻辑API（前端模拟）

| 类别         | API名称                              | 功能描述                                                                 | 使用场景                                  |
|--------------|--------------------------------------|--------------------------------------------------------------------------|-------------------------------------------|
| 预约管理     | `app.reserveSeat()`                  | 全局方法，模拟预约座位（包含存储更新）                                   | 图书馆详情页提交座位预约                  |
| 预约管理     | `app.cancelReservation()`            | 全局方法，模拟取消预约（更新状态与存储）                                 | 历史记录页取消未使用的预约                |
| 数据更新     | `updateLibrariesFromGlobal()`        | 页面方法，从全局数据更新图书馆信息（含随机模拟）                         | 定时刷新或WebSocket消息触发时更新数据    |
| 图表渲染     | `renderChart()`                      | 页面方法，使用D3.js绘制图书馆使用率图表                                   | 首页初始化或数据更新时渲染图表            |
| 图表更新     | `updateChart()`                      | 页面方法，动态更新图表数据（带动画过渡）                                 | 座位数据变化时同步更新图表                |

## 三、D3.js图表API

| 类别         | API名称                              | 功能描述                                                                 | 使用场景                                  |
|--------------|--------------------------------------|--------------------------------------------------------------------------|-------------------------------------------|
| 元素选择     | `d3.select()`                        | 选择DOM元素（如容器、SVG）                                               | 初始化图表容器、创建SVG元素                |
| 比例尺       | `d3.scaleBand()`                     | 创建带状比例尺（适用于分类数据，如图书馆名称）                           | 定义图表X轴（图书馆名称映射）            |
| 比例尺       | `d3.scaleLinear()`                   | 创建线性比例尺（适用于连续数据，如使用率）                               | 定义图表Y轴（使用率百分比映射）          |
| 坐标轴       | `d3.axisBottom()`                    | 创建底部坐标轴（水平方向）                                               | 绘制图表X轴刻度与标签                    |
| 坐标轴       | `d3.axisLeft()`                      | 创建左侧坐标轴（垂直方向）                                               | 绘制图表Y轴刻度与标签                    |
| 数据绑定     | `selection.data()`                   | 将数据绑定到DOM元素                                                       | 柱状图数据与矩形元素绑定                  |
| 数据绑定     | `selection.enter()`                  | 处理新增数据（数据量大于元素数量时）                                     | 初始化图表时创建柱状元素                  |
| 动画过渡     | `transition()`                       | 定义元素状态变化的过渡动画                                               | 图表数据更新时的平滑过渡效果              |

## 说明

1. **实际应用扩展**：  
   - 真实环境中需添加 `wx.request()` 用于HTTP接口请求（如初始化图书馆列表、提交反馈）。  
   - WebSocket地址需替换为真实服务器地址，并在小程序管理后台配置合法域名。

2. **API版本兼容性**：  
   - 微信小程序API需兼容基础库版本 `2.10.0+`，确保覆盖主流用户设备。  
   - D3.js建议使用 `v7+` 版本，避免旧版API兼容问题。

3. **错误处理**：  
   - 所有异步API（如 `wx.connectSocket()`、`wx.getUserProfile()`）需添加错误监听（`fail` 回调）。  
   - 业务API需处理边界情况（如座位已被预约、网络中断等）。
